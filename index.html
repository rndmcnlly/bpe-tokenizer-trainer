<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPE Tokenizer Trainer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .panel {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            resize: vertical;
        }
        input[type="number"] {
            width: 80px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .progress-container {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .vocab-list {
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        .merge-step {
            background: white;
            border: 1px solid #ddd;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .token {
            background: #e7f3ff;
            border: 1px solid #0066cc;
            padding: 2px 4px;
            margin: 1px;
            border-radius: 3px;
            display: inline-block;
            font-family: monospace;
            font-size: 11px;
        }
        .controls {
            margin: 10px 0;
        }
        .status {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>BPE Tokenizer Trainer</h1>
    <p>Train a Byte Pair Encoding tokenizer on your text and see how it works step by step.</p>
    
    <div class="controls">
        <label>
            Target Vocab Size: 
            <input type="number" id="vocabSize" value="300" min="256" max="1000">
        </label>
        <button onclick="trainBPE()" id="trainBtn">Train BPE</button>
        <button onclick="clearResults()" id="clearBtn">Clear</button>
    </div>

    <div class="panel full-width">
        <h3>Training Text</h3>
        <textarea id="trainingText" placeholder="Paste your ASCII text here...">The quick brown fox jumps over the lazy dog. The dog was very lazy and the fox was very quick. This is a sample text for training a BPE tokenizer. We need repeated patterns to see meaningful merges.</textarea>
    </div>

    <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="status" id="status"></div>

    <div class="container">
        <div class="panel">
            <h3>Merge Steps</h3>
            <div id="mergeSteps" class="vocab-list"></div>
        </div>
        
        <div class="panel">
            <h3>Final Vocabulary</h3>
            <div id="vocabulary" class="vocab-list"></div>
        </div>
    </div>

    <div class="panel full-width">
        <h3>Tokenize New Text</h3>
        <textarea id="tokenizeText" placeholder="Enter text to tokenize with the trained BPE model...">The quick brown fox</textarea>
        <br>
        <button onclick="tokenizeText()" id="tokenizeBtn" disabled>Tokenize</button>
        <div id="tokenizedResult" style="margin-top: 10px;"></div>
    </div>

    <script>
        let vocab = {};
        let merges = [];

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function byteToString(byte) {
            if (byte >= 32 && byte <= 126) {
                return String.fromCharCode(byte);
            }
            return `\\x${byte.toString(16).padStart(2, '0')}`;
        }

        function tokensToString(tokens) {
            return tokens.map(t => vocab[t]).join('');
        }

        async function trainBPE() {
            const text = document.getElementById('trainingText').value;
            const targetVocabSize = parseInt(document.getElementById('vocabSize').value);
            
            if (!text.trim()) {
                alert('Please enter some training text');
                return;
            }

            // Reset state
            vocab = {};
            merges = [];
            document.getElementById('trainBtn').disabled = true;
            document.getElementById('tokenizeBtn').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('mergeSteps').innerHTML = '';
            document.getElementById('vocabulary').innerHTML = '';
            
            // Initialize vocab with bytes
            for (let i = 0; i < 256; i++) {
                vocab[i] = String.fromCharCode(i);
            }
            
            // Convert text to byte tokens
            let tokens = [];
            for (let i = 0; i < text.length; i++) {
                tokens.push(text.charCodeAt(i));
            }
            
            let nextTokenId = 256;
            const totalSteps = targetVocabSize - 256;
            let step = 0;
            
            while (Object.keys(vocab).length < targetVocabSize) {
                // Update progress
                const progress = (step / totalSteps) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('status').textContent = 
                    `Step ${step + 1}/${totalSteps}: Vocabulary size ${Object.keys(vocab).length}`;
                
                // Count adjacent pairs
                const pairCounts = {};
                for (let i = 0; i < tokens.length - 1; i++) {
                    const pair = `${tokens[i]},${tokens[i + 1]}`;
                    pairCounts[pair] = (pairCounts[pair] || 0) + 1;
                }
                
                if (Object.keys(pairCounts).length === 0) break;
                
                // Find most frequent pair
                let bestPair = null;
                let bestCount = 0;
                for (const [pair, count] of Object.entries(pairCounts)) {
                    if (count > bestCount) {
                        bestCount = count;
                        bestPair = pair.split(',').map(x => parseInt(x));
                    }
                }
                
                if (bestCount <= 1) break;
                
                // Create new token
                vocab[nextTokenId] = vocab[bestPair[0]] + vocab[bestPair[1]];
                merges.push({
                    step: step + 1,
                    pair: bestPair,
                    newToken: nextTokenId,
                    count: bestCount,
                    result: vocab[nextTokenId]
                });
                
                // Replace all occurrences
                const newTokens = [];
                let i = 0;
                while (i < tokens.length) {
                    if (i < tokens.length - 1 && 
                        tokens[i] === bestPair[0] && 
                        tokens[i + 1] === bestPair[1]) {
                        newTokens.push(nextTokenId);
                        i += 2;
                    } else {
                        newTokens.push(tokens[i]);
                        i += 1;
                    }
                }
                tokens = newTokens;
                
                // Update UI
                displayMergeStep(merges[merges.length - 1]);
                
                nextTokenId++;
                step++;
                
                // Allow UI to update
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            // Complete
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('status').textContent = 
                `Training complete! Final vocabulary size: ${Object.keys(vocab).length}`;
            document.getElementById('trainBtn').disabled = false;
            document.getElementById('tokenizeBtn').disabled = false;
            
            displayVocabulary();
        }

        function displayMergeStep(merge) {
            const div = document.createElement('div');
            div.className = 'merge-step';
            div.innerHTML = `
                <strong>Step ${merge.step}:</strong> 
                "${escapeHtml(vocab[merge.pair[0]])}" + "${escapeHtml(vocab[merge.pair[1]])}" 
                â†’ "${escapeHtml(merge.result)}" 
                (${merge.count} occurrences)
            `;
            document.getElementById('mergeSteps').appendChild(div);
            document.getElementById('mergeSteps').scrollTop = document.getElementById('mergeSteps').scrollHeight;
        }

        function displayVocabulary() {
            const vocabDiv = document.getElementById('vocabulary');
            vocabDiv.innerHTML = '';
            
            // Show learned tokens (256+)
            const learnedTokens = Object.entries(vocab)
                .filter(([id, _]) => parseInt(id) >= 256)
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            learnedTokens.forEach(([id, value]) => {
                const div = document.createElement('div');
                div.innerHTML = `${id}: "${escapeHtml(value)}"`;
                vocabDiv.appendChild(div);
            });
            
            if (learnedTokens.length === 0) {
                vocabDiv.innerHTML = '<em>No learned tokens yet</em>';
            }
        }

        function tokenizeText() {
            const text = document.getElementById('tokenizeText').value;
            if (!text) return;
            
            // Convert to initial tokens
            let tokens = [];
            for (let i = 0; i < text.length; i++) {
                tokens.push(text.charCodeAt(i));
            }
            
            // Apply merges in order
            for (const merge of merges) {
                const newTokens = [];
                let i = 0;
                while (i < tokens.length) {
                    if (i < tokens.length - 1 && 
                        tokens[i] === merge.pair[0] && 
                        tokens[i + 1] === merge.pair[1]) {
                        newTokens.push(merge.newToken);
                        i += 2;
                    } else {
                        newTokens.push(tokens[i]);
                        i += 1;
                    }
                }
                tokens = newTokens;
            }
            
            // Display result
            const resultDiv = document.getElementById('tokenizedResult');
            resultDiv.innerHTML = '<strong>Tokens:</strong><br>';
            tokens.forEach(tokenId => {
                const span = document.createElement('span');
                span.className = 'token';
                span.textContent = `${tokenId}:"${vocab[tokenId]}"`;
                resultDiv.appendChild(span);
            });
            
            resultDiv.innerHTML += `<br><br><strong>Token count:</strong> ${tokens.length}`;
        }

        function clearResults() {
            document.getElementById('mergeSteps').innerHTML = '';
            document.getElementById('vocabulary').innerHTML = '';
            document.getElementById('tokenizedResult').innerHTML = '';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('status').textContent = '';
            document.getElementById('tokenizeBtn').disabled = true;
            vocab = {};
            merges = [];
        }
    </script>
</body>
</html>